const repostCheckbox=document.getElementById("makeReposts"),postNowCheckbox=document.getElementById("postNow"),scheduledDate=document.getElementById("scheduledDate"),urlCardBox=document.getElementById("urlCard"),recordUrlBox=document.getElementById("recordBox"),content=document.getElementById("content");let hasFileLimit=!1,fileData=new Map;const imageAttachmentSection=document.getElementById("imageAttachmentSection"),linkAttachmentSection=document.getElementById("webLinkAttachmentSection");function addOnUnloadBlocker(){window.onbeforeunload=function(){document.querySelectorAll(".fileDel").forEach(e=>{e.click()})}}function clearOnUnloadBlocker(){window.onbeforeunload=null}function setElementRequired(e,t){t?e.setAttribute("required",!0):e.removeAttribute("required")}function setElementVisible(e,t){t?e.classList.remove("hidden"):e.classList.add("hidden")}function setElementDisabled(e,t){t?e.setAttribute("disabled",!0):e.removeAttribute("disabled")}urlCardBox.addEventListener("paste",()=>{showContentLabeler(!0),setElementVisible(imageAttachmentSection,!1)}),urlCardBox.addEventListener("input",()=>{const e=urlCardBox.value.length>0;showContentLabeler(e),setElementVisible(imageAttachmentSection,!e)});let fileDropzone=new Dropzone("#fileUploads",{url:"/post/upload",autoProcessQueue:!0,maxFilesize:FILE_DROP_MAX_SIZE,maxThumbnailFilesize:FILE_DROP_MAX_THUMB_SIZE,acceptedFiles:fileTypesSupported.toString()});function setSelectDisable(e){document.querySelectorAll("select:not(#contentLabels)").forEach(t=>setElementDisabled(t,e))}function showContentLabeler(e){const t=document.getElementById("content-label-selector"),n=document.getElementById("contentLabels");!e&&(fileData.length>0||urlCardBox.value.length>0)||(setElementVisible(t,e),setElementRequired(n,e),e||(n.value=""))}function showPostProgress(e){const t=document.getElementById("makingPostRequest");t.setAttribute("aria-busy",e),setElementDisabled(t,e),t.innerHTML=e?"Making Post...":"Schedule Post"}function openAltText(e,t,n,o){const s=document.getElementById("altTextDialog"),a=document.getElementById("altTextField"),l=document.getElementById("altThumbImg"),r=document.getElementById("altTextSaveButton"),i=document.getElementById("altTextCancelButton"),c=e instanceof File,d=c?URL.createObjectURL(e):`preview/file/${e}`;!1===s.hasAttribute("hasReset")&&(document.addEventListener("resetPost",()=>{a.value="",l.src="",resetCounter("altTextCount")}),s.setAttribute("hasReset",!0)),a.value=n()||"",recountCounter("altTextCount"),tributeToElement(a);const u=e=>{e.preventDefault();const n=a.value;o(n),""===n?t.classList.remove("btn-success"):t.classList.add("btn-success"),h()},m=()=>{r.removeEventListener("click",u),i.removeEventListener("click",h),s.removeEventListener("close",m),l.src="",c&&URL.revokeObjectURL(d),detachTribute(a)},h=()=>{m(),closeModal(s)};l.src=d,r.addEventListener("click",u),i.addEventListener("click",h),s.addEventListener("close",m),openModal(s)}function searchBSkyMentions(e,t){const n=new XMLHttpRequest;n.open("GET",`https://public.api.bsky.app/xrpc/app.bsky.actor.searchActorsTypeahead?q=${e}&limit=${MAX_AUTO_COMPLETE_NAMES}`),n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){if(200===n.status)try{const e=JSON.parse(n.responseText);return void t(e.actors)}catch(e){console.error(`failed to parse bsky mention list ${e}`)}console.error(`fetching bluesky mentionlist returned ${n.status}`),t([])}},n.send()}function tributeToElement(e){const t=new Tribute({menuItemTemplate:function(e){return`${void 0!==e.original.avatar?`<img src="${e.original.avatar}">`:""}<span><code>${e.original.displayName}</code><br /> <small>@${e.original.handle}</small></span>`},values:function(e,t){searchBSkyMentions(e,e=>t(e))},noMatchTemplate:()=>'<span class="acBskyHandle">No Match Found</span>',lookup:"handle",fillAttr:"handle",spaceSelectsMatch:!0,menuItemLimit:MAX_AUTO_COMPLETE_NAMES,menuShowMinLength:MIN_CHAR_AUTO_COMPLETE_NAMES,menuContainer:e.parentNode});e.addEventListener("detach",()=>{t.detach(e)}),t.attach(e)}function detachTribute(e){e.dispatchEvent(new Event("detach"))}function openPostAltEditor(e){const t=document.querySelector(`div[alteditfor="${e}"]`),n=t.querySelector("input[data-alt]");openAltText(e,t.querySelector("a"),()=>n.getAttribute("value"),e=>{n.setAttribute("value",e)})}document.addEventListener("resetPost",()=>{document.getElementById("postForm").reset(),setElementVisible(imageAttachmentSection,!0),setElementVisible(linkAttachmentSection,!0),showContentLabeler(!1),setSelectDisable(!0),setElementRequired(scheduledDate,!0),showPostProgress(!1),clearOnUnloadBlocker(),repostCheckbox.checked=!1,postNowCheckbox.checked=!1,hasFileLimit=!1,urlCardBox.value="",recordUrlBox.value="",resetCounter("count"),fileDropzone.removeAllFiles(),fileData.clear()}),fileDropzone.on("reset",()=>{hasFileLimit=!1,clearOnUnloadBlocker(),showContentLabeler(!1),setElementVisible(linkAttachmentSection,!0)}),fileDropzone.on("addedfile",e=>{if(!0===hasFileLimit)return fileDropzone.removeFile(e),void pushToast("Maximum number of files reached",!1);setElementVisible(linkAttachmentSection,!1);const t=Dropzone.createElement("<fieldset role='group' class='imgbtn'></fieldset>"),n=Dropzone.createElement("<button class='fileDel outline btn-error' disabled><small>Remove file</small></button>"),o=Dropzone.createElement("<button class='outline' disabled><small>Add Alt Text</small></button><br />");o.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),openAltText(e,o,()=>fileData.get(e.name).alt,t=>{const n=fileData.get(e.name);n.alt=t,fileData.set(e.name,n)})}),n.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),fetch("/post/upload",{method:"DELETE",keepalive:!0,body:JSON.stringify({content:fileData.get(e.name).content})}).then(async t=>{const o=await t.json();if(o.success)fileData.delete(e.name),fileDropzone.removeFile(e),n.hasAttribute("bad")||pushToast(`Deleted file ${e.name}`,!0);else{const t=translateErrorObject(o.error,"Unknown Error");pushToast(`Unable to delete file ${e.name}! ${t}`,!1)}0==fileData.length&&setElementVisible(linkAttachmentSection,!0)})}),imageTypes.includes(e.type)&&t.appendChild(o),t.appendChild(n),e.previewElement.appendChild(t)}),fileDropzone.on("success",function(e,t){const n=()=>{const t=e.previewElement.querySelectorAll(".fileDel")[0];t.setAttribute("bad",!0),t.click()};showContentLabeler(!0);const o=imageTypes.includes(e.type),s=videoTypes.includes(e.type),a=gifTypes.includes(e.type);if(console.log(`Adding ${e.name} (${e.type}) to the fileData map with size: ${t.fileSize} at quality ${t.qualityLevel||100}`),s){const o=document.createElement("video"),s=URL.createObjectURL(e),a=()=>{o.removeAttribute("src"),URL.revokeObjectURL(s),o.remove()};o.setAttribute("hidden",!0),o.setAttribute("src",s),o.addEventListener("loadeddata",()=>{const s=o.duration;s>MAX_VIDEO_LENGTH?(pushToast(`${e.name} is too long for bsky by ${(s-MAX_VIDEO_LENGTH).toFixed(2)} seconds`,!1),n()):(fileData.set(e.name,{content:t.data,type:3,height:o.videoHeight,width:o.videoWidth,duration:s}),hasFileLimit=!0),a()}),o.addEventListener("error",()=>{pushToast(`Unable to process ${e.name}, decoder error occurred`),n(),a()}),document.body.appendChild(o)}else if(a){const o=new Image,s=URL.createObjectURL(e),a=e=>{const t=new Uint8Array(e);let n=0;try{for(let e=0,o=t.length;e<o;e++)if(33==t[e]&&249==t[e+1]&&4==t[e+2]&&0==t[e+7]){const o=t[e+5]<<8|255&t[e+4];n+=o<2?10:o}return n/100}catch(e){return console.error(`Unable to read gif file, got error ${e}`),null}};o.onload=async()=>{if(""===o.src)return;const l=a(await e.arrayBuffer());o.src="",URL.revokeObjectURL(s),null===l?(pushToast(`${e.name} duration could not be processed`,!1),n()):l>MAX_VIDEO_LENGTH?(pushToast(`${e.name} is too long for bsky by ${(l-MAX_VIDEO_LENGTH).toFixed(2)} seconds`,!1),n()):(fileData.set(e.name,{content:t.data,type:3,height:o.height,width:o.width,duration:l}),hasFileLimit=!0)},o.src=s}else fileData.set(e.name,{content:t.data,type:1});e.previewElement.querySelectorAll("button").forEach(e=>setElementDisabled(e,!1));try{const n=fileDropzone.filesize(t.fileSize),l=e.previewElement.querySelector(".dz-size"),r=e.previewElement.querySelector(".dz-details");l.firstChild.innerHTML=n;const i=Dropzone.createElement(`<div class="dz-size"><span>Quality: ${t.qualityLevel||100}%</span></div>`);r.insertBefore(i,l),e.previewElement.querySelector(".dz-filename").setAttribute("title",e.name),s?this.emit("thumbnail",e,"/thumbs/video.png"):n>FILE_DROP_MAX_THUMB_SIZE&&(o?this.emit("thumbnail",e,"/thumbs/image.png"):a&&this.emit("thumbnail",e,"/thumbs/gif.png"))}catch(e){console.error(e)}addOnUnloadBlocker()}),fileDropzone.on("error",function(e,t){pushToast(`Error: ${e.name} had error: "${t.error}"`,!1),fileDropzone.removeFile(e),0==fileData.length&&setElementVisible(linkAttachmentSection,!0)}),document.getElementById("postForm").addEventListener("submit",async e=>{e.preventDefault(),showPostProgress(!0);const t=content.value,n=postNowCheckbox.checked,o=scheduledDate.value;let s;try{s=n?(new Date).toISOString():new Date(o).toISOString()}catch(e){return pushToast("Invalid date",!1),void showPostProgress(!1)}try{const e={content:t,scheduledDate:s,makePostNow:n,repostData:void 0};repostCheckbox.checked&&(e.repostData={hours:document.getElementById("hoursInterval").value,times:document.getElementById("timesInterval").value});const o=fileData.size>0,a=urlCardBox.value,l=recordUrlBox.value,r=a.length>0,i=l.length>0;if(o||r){if(e.embeds=[],o)fileData.forEach((t,n)=>{e.embeds.push(t)});else{const t={uri:a,type:2},n=await fetch(`https://cardyb.bsky.app/v1/extract?url=${encodeURI(a)}`);if(!n.ok)return pushToast("Unable to fetch URL card embed information...",!1),void showPostProgress(!1);{const e=await n.json();if(""!==e.error)return console.error(e.error),pushToast("An error occurred with the URL card, please correct.",!1),void showPostProgress(!1);t.description=e.description,t.title=e.title,t.content=e.image}e.embeds.push(t)}e.label=document.getElementById("contentLabels").value}if(i){void 0===e.embeds&&(e.embeds=[]);const t={content:l,type:4};e.embeds.push(t)}const c=JSON.stringify(e),d=await fetch("/post/create",{method:"POST",headers:{"Content-Type":"application/json"},body:c}),u=await d.json();d.ok?(pushToast(u.message,!0),document.dispatchEvent(new Event("resetPost")),window.scrollTo({top:0,left:0,behavior:"smooth"}),refreshPosts()):pushToast(translateErrorObject(u,u.error?.message||u.error||"An Error Occurred"),!1)}catch(e){console.log(e),pushToast("An unknown error occurred",!1)}showPostProgress(!1)}),scheduledDate.addEventListener("change",e=>{const t=new Date(scheduledDate.value);t.setMinutes(0-t.getTimezoneOffset()),scheduledDate.value=t.toISOString().slice(0,16)}),repostCheckbox.addEventListener("click",e=>{setSelectDisable(!repostCheckbox.checked)}),postNowCheckbox.addEventListener("click",e=>{setElementRequired(scheduledDate,!postNowCheckbox.checked)}),addCounter("content","count",MAX_LENGTH),addCounter("altTextField","altTextCount",MAX_ALT_LENGTH),tributeToElement(content),document.dispatchEvent(new Event("resetPost"));
